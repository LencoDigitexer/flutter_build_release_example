name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  flutter_test:
    name: Run Flutter Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: flutter pub get
      - run: flutter --version
      - run: flutter analyze
      - run: flutter test

  build_androidApk:
    name: Build Flutter App (Android)
    needs: [flutter_test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: flutter pub get
      - run: flutter clean
      - run: flutter build apk --split-per-abi
      - uses: actions/upload-artifact@v2
        with:
          name: android-build
          path: build/app/outputs/apk/release/*

  build_windowsExe:
    name: Build Flutter App (Windows)
    needs: [flutter_test]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
      - run: flutter pub get
      - run: flutter clean
      - run: flutter build windows --release
      - name: Zip artifacts
        uses: thedoctor0/zip-release@0.7.5
        with:
          type: 'zip'
          filename: 'release.zip'
          directory: build/windows/x64/runner/Release/
      - uses: actions/upload-artifact@v2
        with:
          name: windows-build
          path: build/windows/x64/runner/Release/release.zip

  create_release:
    name: Create Release
    needs: [build_androidApk, build_windowsExe]
    runs-on: ubuntu-latest
    steps:
      - name: Download Android Artifact
        uses: actions/download-artifact@v2
        with:
          name: android-build
          path: build/app/outputs/apk/release/

      - name: Download Windows Artifact
        uses: actions/download-artifact@v2
        with:
          name: windows-build
          path: build/windows/x64/runner/Release/release.zip

      - name: Create GitHub Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifactErrorsFailBuild: true
          artifacts: |
            build/app/outputs/apk/release/*.apk
            release.zip
          tag: v1.0.${{ github.run_number}}
          token: ${{ secrets.TOKEN }}
